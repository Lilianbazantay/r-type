name: Windows-build

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: bash

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Configure system vcpkg
      run: |
        echo "VCPKG_ROOT=C:/vcpkg" >> $GITHUB_ENV
        echo "VCPKG_EXE=C:/vcpkg/vcpkg.exe" >> $GITHUB_ENV

    - name: Patch installer.sh to use system vcpkg
      shell: pwsh
      run: |
        $installer = Get-Content "installer.sh" -Raw
        $installer = $installer -replace "external/vcpkg/vcpkg\.exe", "$env:VCPKG_EXE"
        $installer = $installer -replace "\./external/vcpkg/bootstrap-vcpkg\.bat", "echo \"Skipping bootstrap (using system vcpkg)\""
        $installer = $installer -replace "cd external/vcpkg", "cd $env:VCPKG_ROOT"
        Set-Content "installer.sh" $installer

    # Install CMake (winget available in bash with this call)
    - name: Install CMake
      shell: pwsh
      run: |
        winget install --id Kitware.CMake -e --source winget

    # Print vcpkg version (sanity-check system install)
    - name: Verify vcpkg
      run: |
        "$VCPKG_EXE" version

    # Run your installer script
    - name: Run installer.sh build
      run: |
        chmod +x installer.sh
        ./installer.sh

    # Upload artifacts (optional)
    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: rtype-windows-release
        path: |
          r-type_client.exe
          r-type_server.exe
