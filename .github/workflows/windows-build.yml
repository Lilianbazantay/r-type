name: Windows-build

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: bash

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # Use system vcpkg
    - name: Configure system vcpkg
      run: |
        echo "Using system vcpkg at C:/vcpkg"
        echo "VCPKG_ROOT=C:/vcpkg" >> $GITHUB_ENV
        echo "VCPKG_EXE=C:/vcpkg/vcpkg.exe" >> $GITHUB_ENV

    # Patch installer.sh to use system vcpkg instead of the submodule version
    - name: Patch installer.sh to use system vcpkg
      run: |
        sed -i 's#external/vcpkg/vcpkg.exe#${VCPKG_EXE//#/\\#}#g' installer.sh
        sed -i 's#./external/vcpkg/bootstrap-vcpkg.bat#echo "Skipping bootstrap (using system vcpkg)"#g' installer.sh
        sed -i 's#cd external/vcpkg#cd ${VCPKG_ROOT//#/\\#}#g' installer.sh

    # Install CMake (winget available in bash with this call)
    - name: Install CMake
      shell: pwsh
      run: |
        winget install --id Kitware.CMake -e --source winget

    # Print vcpkg version (sanity-check system install)
    - name: Verify vcpkg
      run: |
        "$VCPKG_EXE" version

    # Run your installer script
    - name: Run installer.sh build
      run: |
        chmod +x installer.sh
        ./installer.sh

    # Upload artifacts (optional)
    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: rtype-windows-release
        path: |
          r-type_client.exe
          r-type_server.exe
